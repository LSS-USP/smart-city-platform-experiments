#!/bin/sh

FILE_DIR=`perl -e 'use Cwd "abs_path";print abs_path(shift)' $0`
BASE_DIR=`dirname $FILE_DIR`/..
CLUSTER=cluster-xp
ZONE=us-central1-f
MACHINE_TYPE=n1-standard-1
NUM_NODES=4

verify () {
  if [ $? != 0 ]; then
    echo "$1"
    exit 2
  fi
}

if [ "$1" = "create" ]; then
  echo "Creating the cluster"

  gcloud container clusters create $CLUSTER --zone $ZONE --machine-type $MACHINE_TYPE --num-nodes $NUM_NODES --preemptible
  #gcloud deployment-manager deployments create cluster --config cluster/cluster.yaml 
  gcloud container clusters get-credentials $CLUSTER 

  echo "Creating postgres service"
  kubectl create -f kubernetes/objects/postgres.yaml 
  
  echo "Preparing database"
  kubectl create -f kubernetes/objects/kong_migration_postgres.yaml 
  kubectl delete -f kubernetes/objects/kong_migration_postgres.yaml
  
  echo "Deploying Kong"
  kubectl create -f kubernetes/objects/kong_postgres.yaml
fi

if [ "$1" = "delete" ]; then
  echo "Deleting postgres service"
  kubectl delete -f kubernetes/objects/postgres.yaml 
  
  echo "Deleting Kong"
  kubectl delete -f kubernetes/objects/kong_postgres.yaml
 
  echo "Deleting the cluster"
  gcloud container clusters delete $CLUSTER --zone $ZONE 
  
  echo "Cluster deleted!"
fi
